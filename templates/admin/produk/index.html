{% extends 'admin/layout/base_admin.html' %}

{% block title %}Manajemen Produk - Admin E-Commerce{% endblock %}


{% block page_heading %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Manajemen Produk</h1>
    <a href="{{ url_for('produk.tambah') }}" class="btn btn-primary btn-icon-split" >
        <span class="icon text-white-50">
            <i class="fas fa-plus"></i>
        </span>
        <span class="text">Tambah Produk</span>
    </a>
</div>


{% endblock %}

{% block content %}
<!-- DataTables Card -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold " style="color: #57726E;">Daftar Produk</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th width="5%">ID</th>
                        <th width="10%">Gambar</th>
                        <th width="25%">Nama Produk</th>
                        <th width="15%">Kategori</th>
                        <th width="12%">Harga</th>
                        <th width="8%">Stok</th>
                        <th width="25%">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for produk in produks %}
                    <tr id="row-{{ produk.id }}">
                        <td>{{ produk.id }}</td>
                        <td>
                            {% if produk.gambar_utama %}
                            <img src="{{ url_for('static', filename='gambar_produk/' + produk.gambar_utama) }}" 
                                 alt="{{ produk.nama_barang }}" 
                                 class="img-thumbnail" 
                                 style="width: 60px; height: 60px; object-fit: cover;">
                            {% else %}
                            <img src="{{ url_for('static', filename='assets_sb_admin/img/undraw_profile.svg') }}" 
                                 alt="No Image" 
                                 class="img-thumbnail" 
                                 style="width: 60px; height: 60px; object-fit: cover;">
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ produk.nama_barang }}</strong><br>
                            <small class="text-muted">{{ produk.deskripsi[:50] }}...</small>
                        </td>
                        <td>
                            {% if produk.nama_kategori %}
                            <span class="badge badge-info">{{ produk.nama_kategori }}</span>
                            {% else %}
                            <span class="badge badge-secondary">Tanpa Kategori</span>
                            {% endif %}
                        </td>
                        <td>Rp {{ "{:,.0f}".format(produk.harga) }}</td>
                        <td>
                            {% if produk.stok > 10 %}
                            <span class="badge badge-success">{{ produk.stok }}</span>
                            {% elif produk.stok > 0 %}
                            <span class="badge badge-warning">{{ produk.stok }}</span>
                            {% else %}
                            <span class="badge badge-danger">Habis</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('produk.edit', id=produk.id) }}" 
                               class="btn btn-sm btn-warning" 
                               title="Edit">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <button class="btn btn-sm btn-danger btn-delete" 
                                    data-id="{{ produk.id }}"
                                    data-nama="{{ produk.nama_barang }}"
                                    title="Hapus">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='assets_sb_admin/vendor/datatables/dataTables.bootstrap4.min.css') }}" rel="stylesheet">
<style>
    :root{
        --admin-primary: #57726E;
        --admin-primary-hover: #47665F;
    }

    .btn-sm {
        margin: 2px 0;
    }

    /* Override Add Product split button color on Produk page */
    .btn-icon-split.btn-primary {
        background-color: var(--admin-primary) !important;
        border-color: var(--admin-primary) !important;
        color: #fff !important;
    }
    .btn-icon-split.btn-primary .icon {
        background: rgba(255,255,255,0.08) !important;
    }
    .btn-icon-split.btn-primary:hover {
        background-color: var(--admin-primary-hover) !important;
        border-color: var(--admin-primary-hover) !important;
        color: #fff !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='assets_sb_admin/vendor/datatables/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets_sb_admin/vendor/datatables/dataTables.bootstrap4.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#dataTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Indonesian.json"
        },
        "order": [[0, "desc"]]
    });

    // Button Delete
    $('.btn-delete').click(function() {
        var id = $(this).data('id');
        var nama = $(this).data('nama');
        
        Swal.fire({
            title: 'Apakah Anda yakin?',
            text: "Produk '" + nama + "' dan semua gambarnya akan dihapus!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Hapus!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "{{ url_for('produk.delete', id=0) }}".replace('0', id),
                    type: 'POST',
                    success: function(response) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Terhapus!',
                            text: response.message,
                            showConfirmButton: false,
                            timer: 1500
                        }).then(function() {
                            location.reload();
                        });
                    },
                    error: function(xhr) {
                        var message = xhr.responseJSON && xhr.responseJSON.message 
                            ? xhr.responseJSON.message 
                            : 'Terjadi kesalahan saat menghapus produk';
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Gagal!',
                            text: message
                        });
                    }
                });
            }
        });
    });
});
</script>
{% endblock %}