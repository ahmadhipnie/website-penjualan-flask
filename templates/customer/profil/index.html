{% extends 'customer/layout/base_customer.html' %}

{% block title %}Profil Saya - E-Commerce{% endblock %}

{% block page_heading %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Profil Saya</h1>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-4">
        <!-- Profil Card -->
        <div class="card shadow mb-4">
            <div class="card-body text-center">
                <div class="mb-3">
                    <img src="{{ url_for('static', filename='assets_sb_admin/img/undraw_profile.svg') }}" 
                         class="img-fluid rounded-circle" style="width: 100px;" alt="Profile">
                </div>
                {% if user_data %}
                <h5 class="font-weight-bold">{{ user_data.nama }}</h5>
                <p class="text-muted">{{ user_data.role.title() if user_data.role else 'Customer' }}</p>
                <p><i class="fas fa-envelope"></i> {{ user_data.email }}</p>
                <p><i class="fas fa-phone"></i> {{ user_data.nomor_telepon }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Menu Cepat -->
        
    </div>

    <div class="col-lg-8">
        <!-- Informasi Pribadi -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Informasi Pribadi</h6>
                <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#editProfilModal">
                    <i class="fas fa-edit"></i> Edit
                </button>
            </div>
            <div class="card-body">
                {% if user_data %}
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Nama Lengkap</strong></div>
                    <div class="col-md-8">{{ user_data.nama }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Email</strong></div>
                    <div class="col-md-8">{{ user_data.email }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Nomor Telepon</strong></div>
                    <div class="col-md-8">{{ user_data.nomor_telepon }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Tanggal Lahir</strong></div>
                    <div class="col-md-8">{{ user_data.tanggal_lahir.strftime('%d %B %Y') if user_data.tanggal_lahir else '-' }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Jenis Kelamin</strong></div>
                    <div class="col-md-8">{{ 'Laki-laki' if user_data.jenis_kelamin == 'L' else 'Perempuan' }}</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Alamat Pengiriman -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Alamat Pengiriman</h6>
                <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#tambahAlamatModal">
                    <i class="fas fa-plus"></i> Tambah Alamat
                </button>
            </div>
            <div class="card-body">
                {% if alamat_list %}
                    {% for alamat in alamat_list %}
                    <div class="border p-3 mb-3 rounded">
                        <div class="d-flex justify-content-between">
                            <div>
                                <p class="mb-1"><strong>{{ alamat.alamat }}</strong></p>
                                <p class="text-muted mb-0">
                                    {{ alamat.kecamatan }}, {{ alamat.kabupaten }}, {{ alamat.provinsi }} - {{ alamat.kode_pos }}
                                </p>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="editAlamat({{ alamat.id }}, '{{ alamat.alamat }}', '{{ alamat.provinsi }}', '{{ alamat.kabupaten }}', '{{ alamat.kecamatan }}', {{ alamat.kode_pos }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="hapusAlamat({{ alamat.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-center text-muted">Belum ada alamat pengiriman</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit Profil -->
<div class="modal fade" id="editProfilModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Profil</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="formEditProfil" method="POST" action="{{ url_for('customer.update_profil') }}">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Nama Lengkap <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="nama" value="{{ user_data.nama if user_data else '' }}" required>
                    </div>
                    <div class="form-group">
                        <label>Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" name="email" value="{{ user_data.email if user_data else '' }}" required>
                    </div>
                    <div class="form-group">
                        <label>Nomor Telepon <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="nomor_telepon" value="{{ user_data.nomor_telepon if user_data else '' }}" required>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Lahir <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="tanggal_lahir" 
                               value="{{ user_data.tanggal_lahir.strftime('%Y-%m-%d') if user_data and user_data.tanggal_lahir else '' }}" required>
                    </div>
                    <div class="form-group">
                        <label>Jenis Kelamin <span class="text-danger">*</span></label>
                        <select class="form-control" name="jenis_kelamin" required>
                            <option value="L" {{ 'selected' if user_data and user_data.jenis_kelamin == 'L' else '' }}>Laki-laki</option>
                            <option value="P" {{ 'selected' if user_data and user_data.jenis_kelamin == 'P' else '' }}>Perempuan</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Tambah Alamat -->
<div class="modal fade" id="tambahAlamatModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tambah Alamat</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="formTambahAlamat" method="POST" action="{{ url_for('customer.tambah_alamat') }}">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Alamat Lengkap <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="alamat" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Provinsi <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="provinsi" required>
                    </div>
                    <div class="form-group">
                        <label>Kabupaten/Kota <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="kabupaten" required>
                    </div>
                    <div class="form-group">
                        <label>Kecamatan <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="kecamatan" required>
                    </div>
                    <div class="form-group">
                        <label>Kode Pos <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="kode_pos" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Edit Alamat -->
<div class="modal fade" id="editAlamatModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Alamat</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="formEditAlamat" method="POST">
                <input type="hidden" name="id" id="edit_alamat_id">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Alamat Lengkap <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="alamat" id="edit_alamat" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Provinsi <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="provinsi" id="edit_provinsi" required>
                    </div>
                    <div class="form-group">
                        <label>Kabupaten/Kota <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="kabupaten" id="edit_kabupaten" required>
                    </div>
                    <div class="form-group">
                        <label>Kecamatan <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="kecamatan" id="edit_kecamatan" required>
                    </div>
                    <div class="form-group">
                        <label>Kode Pos <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="kode_pos" id="edit_kode_pos" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('Script profil loaded');
    
    // Edit Alamat
    window.editAlamat = function(id, alamat, provinsi, kabupaten, kecamatan, kode_pos) {
        $('#edit_alamat_id').val(id);
        $('#edit_alamat').val(alamat);
        $('#edit_provinsi').val(provinsi);
        $('#edit_kabupaten').val(kabupaten);
        $('#edit_kecamatan').val(kecamatan);
        $('#edit_kode_pos').val(kode_pos);
        $('#formEditAlamat').attr('action', '/customer/alamat/update/' + id);
        $('#editAlamatModal').modal('show');
    }

    // Hapus Alamat
    window.hapusAlamat = function(id) {
        if (confirm('Apakah Anda yakin ingin menghapus alamat ini?')) {
            $.ajax({
                url: '/customer/alamat/delete/' + id,
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        alert('Alamat berhasil dihapus');
                        location.reload();
                    } else {
                        alert('Gagal menghapus alamat: ' + response.message);
                    }
                },
                error: function() {
                    alert('Terjadi kesalahan saat menghapus alamat');
                }
            });
        }
    }

    // Handle form Edit Profil
    $('#formEditProfil').on('submit', function(e) {
        e.preventDefault();
        console.log('Form edit profil submitted');
        var form = $(this);
        
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            dataType: 'json',
            success: function(response) {
                console.log('Response:', response);
                if (response.success) {
                    $('#editProfilModal').modal('hide');
                    alert('Profil berhasil diupdate');
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                } else {
                    alert('Gagal update profil: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat update profil');
            }
        });
        
        return false;
    });

    // Handle form Tambah Alamat
    $('#formTambahAlamat').on('submit', function(e) {
        e.preventDefault();
        console.log('Form tambah alamat submitted');
        var form = $(this);
        
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            dataType: 'json',
            success: function(response) {
                console.log('Response:', response);
                if (response.success) {
                    $('#tambahAlamatModal').modal('hide');
                    alert('Alamat berhasil ditambahkan');
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                } else {
                    alert('Gagal menambah alamat: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menambah alamat');
            }
        });
        
        return false;
    });

    // Handle form Edit Alamat
    $('#formEditAlamat').on('submit', function(e) {
        e.preventDefault();
        console.log('Form edit alamat submitted');
        var form = $(this);
        
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            dataType: 'json',
            success: function(response) {
                console.log('Response:', response);
                if (response.success) {
                    $('#editAlamatModal').modal('hide');
                    alert('Alamat berhasil diupdate');
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                } else {
                    alert('Gagal update alamat: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat update alamat');
            }
        });
        
        return false;
    });
});
</script>
{% endblock %}
