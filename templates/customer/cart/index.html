{% extends 'customer/layout/base_customer.html' %}

{% block title %}Keranjang Belanja - E-Commerce{% endblock %}

{% block page_heading %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Keranjang Belanja</h1>
    <a href="{{ url_for('customer.keranjang') }}" class="btn btn-primary btn-sm">
        <i class="fas fa-shopping-bag"></i> Lanjut Belanja
    </a>
</div>
{% endblock %}

{% block content %}
{% if keranjang_items %}
<div class="row">
    <div class="col-lg-8">
        <!-- Keranjang Items -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-shopping-cart"></i> Item di Keranjang ({{ keranjang_items|length }})
                </h6>
            </div>
            <div class="card-body">
                {% for item in keranjang_items %}
                <div class="row mb-3 pb-3 border-bottom align-items-center" id="cart-item-{{ item.id }}">
                    <div class="col-md-2">
                        {% if item.gambar_utama %}
                        <img src="{{ url_for('static', filename='gambar_produk/' + item.gambar_utama) }}" 
                             class="img-fluid rounded" alt="{{ item.nama_barang }}" 
                             style="max-height: 80px; object-fit: cover;">
                        {% else %}
                        <img src="{{ url_for('static', filename='assets_landing/img/product-1.jpg') }}" 
                             class="img-fluid rounded" alt="{{ item.nama_barang }}"
                             style="max-height: 80px; object-fit: cover;">
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <h6 class="mb-1">{{ item.nama_barang }}</h6>
                        <small class="text-muted">Stok tersedia: {{ item.stok }}</small>
                    </div>
                    <div class="col-md-2">
                        <p class="mb-0 font-weight-bold">Rp {{ "{:,.0f}".format(item.harga) }}</p>
                        <small class="text-muted">per item</small>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group input-group-sm">
                            <div class="input-group-prepend">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateQty({{ item.id }}, -1, {{ item.stok }})">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                            <input type="number" class="form-control text-center" id="qty-{{ item.id }}" 
                                   value="{{ item.jumlah }}" min="1" max="{{ item.stok }}" readonly>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateQty({{ item.id }}, 1, {{ item.stok }})">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 text-right">
                        <p class="mb-2 font-weight-bold text-primary" id="subtotal-{{ item.id }}">
                            Rp {{ "{:,.0f}".format(item.harga * item.jumlah) }}
                        </p>
                        <button class="btn btn-danger btn-sm" onclick="hapusItem({{ item.id }})" title="Hapus dari keranjang">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Ringkasan Belanja -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-receipt"></i> Ringkasan Belanja
                </h6>
            </div>
            <div class="card-body">
                {% set total = namespace(value=0) %}
                {% for item in keranjang_items %}
                    {% set total.value = total.value + (item.harga * item.jumlah) %}
                {% endfor %}
                
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal ({{ keranjang_items|length }} item)</span>
                    <span id="subtotal-display">Rp {{ "{:,.0f}".format(total.value) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Ongkir</span>
                    <span class="text-muted">Dihitung di checkout</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-3">
                    <strong>Total</strong>
                    <strong class="text-primary" id="total-display">Rp {{ "{:,.0f}".format(total.value) }}</strong>
                </div>
                <button class="btn btn-primary btn-block" onclick="checkout()">
                    <i class="fas fa-credit-card"></i> Lanjut ke Pembayaran
                </button>
                <a href="{{ url_for('customer.keranjang') }}" class="btn btn-outline-secondary btn-block">
                    <i class="fas fa-shopping-bag"></i> Lanjut Belanja
                </a>
            </div>
        </div>

        <!-- Info Pengiriman -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <h6 class="font-weight-bold mb-3">
                    <i class="fas fa-truck"></i> Informasi Pengiriman
                </h6>
                <ul class="list-unstyled mb-0 small">
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Gratis ongkir min. Rp 100.000</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Estimasi pengiriman 2-5 hari</li>
                    <li class="mb-2"><i class="fas fa-check text-success"></i> Garansi produk original</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- Keranjang Kosong -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-body text-center py-5">
                <i class="fas fa-shopping-cart fa-5x text-gray-300 mb-4"></i>
                <h4 class="text-gray-600 mb-3">Keranjang Belanja Kosong</h4>
                <p class="text-gray-500 mb-4">Anda belum menambahkan produk ke keranjang</p>
                <a href="{{ url_for('customer.keranjang') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-shopping-bag"></i> Mulai Belanja
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Update quantity item
function updateQty(itemId, change, maxStok) {
    var qtyInput = document.getElementById('qty-' + itemId);
    var currentQty = parseInt(qtyInput.value);
    var newQty = currentQty + change;
    
    // Validasi qty
    if (newQty < 1 || newQty > maxStok) {
        if (newQty > maxStok) {
            alert('Jumlah melebihi stok yang tersedia!');
        }
        return;
    }
    
    // Update qty via AJAX
    $.ajax({
        url: '/customer/cart/update/' + itemId,
        method: 'POST',
        data: {
            jumlah: newQty
        },
        success: function(response) {
            if (response.success) {
                // Update tampilan
                qtyInput.value = newQty;
                
                // Update subtotal item
                var harga = response.harga;
                var subtotal = harga * newQty;
                document.getElementById('subtotal-' + itemId).innerHTML = 
                    'Rp ' + subtotal.toLocaleString('id-ID');
                
                // Update total
                updateTotal();
            } else {
                alert('Gagal update keranjang: ' + response.message);
            }
        },
        error: function() {
            alert('Terjadi kesalahan saat update keranjang');
        }
    });
}

// Hapus item dari keranjang
function hapusItem(itemId) {
    if (!confirm('Hapus item ini dari keranjang?')) {
        return;
    }
    
    $.ajax({
        url: '/customer/cart/remove/' + itemId,
        method: 'POST',
        success: function(response) {
            if (response.success) {
                // Hapus dari tampilan
                $('#cart-item-' + itemId).fadeOut(300, function() {
                    $(this).remove();
                    updateTotal();
                    
                    // Cek jika keranjang kosong
                    if ($('.card-body .row').length === 0) {
                        location.reload();
                    }
                });
            } else {
                alert('Gagal hapus item: ' + response.message);
            }
        },
        error: function() {
            alert('Terjadi kesalahan saat hapus item');
        }
    });
}

// Update total keseluruhan
function updateTotal() {
    var total = 0;
    $('[id^="subtotal-"]').each(function() {
        var subtotalText = $(this).text().replace('Rp ', '').replace(/\./g, '');
        total += parseInt(subtotalText);
    });
    
    $('#subtotal-display').text('Rp ' + total.toLocaleString('id-ID'));
    $('#total-display').text('Rp ' + total.toLocaleString('id-ID'));
}

// Checkout
function checkout() {
    // TODO: Implementasi checkout
    alert('Fitur checkout akan segera tersedia');
}
</script>
{% endblock %}
